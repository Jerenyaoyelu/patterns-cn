# 优化加载顺序

学习如何优化加载顺序来提高应用的快速可用性

注：本文极大受来自于 chrome 的 Aurora 团队的灵感启发，尤其是一直以来研究优化加载顺序的 Shubhie Panicker 的影响。

每一个成功的网页加载，一些重要的组件和资源在正确的时机变得可用会带给人一个顺畅的加载体验。这确保了用户感受到应用的性能表现是非常棒的。这种极棒的用户体验通常也会转化成传递[网站关键指标 CWV](https://web.dev/vitals/)。

重要的指标，例如首次内容呈现（First Content Paint）、最大内容呈现（Largest Contentful Paint）、首次输入延迟（First Input Delay）等，用于衡量性能，直接取决于关键资源的加载顺序。例如，如果关键资源（如 hero image[[1]](#references)）未加载，则页面无法拥有其 LCP。本文探讨了资源加载顺序与网页指标之间的关系。我们的目标是提供清晰的指导，以优化加载顺序，以改善网页指标。

在我们建立理想的加载顺序之前，让我们先尝试理解为什么很难正确地确定加载顺序。

## 为何最优加载顺序很难实现？

我们有独特的机会为许多合作伙伴的网站进行性能分析。我们发现，在不同的合作伙伴网站中，存在多个类似的问题，影响了页面的高效加载。

开发人员的期望与浏览器在页面上优先处理资源的方式之间经常存在重大差异，这经常导致性能得分低效。我们进一步分析，以发现是什么导致了这种差距，以下几点总结了我们分析的要点。

### 低效的顺序

优化 Web Vitals 不仅需要对每个指标的含义有很好的理解，还需要知道它们发生的顺序以及它们与不同关键资源的关系。FCP 在 LCP 之前发生，而 LCP 在 FID 之前发生。因此，为了实现 FCP，必须优先处理实现 FCP 所需的资源，然后是实现 LCP 所需的资源，最后是实现 FID 所需的资源。

资源经常没有按正确的顺序进行排序和处理。这可能是因为开发人员不知道指标对资源的加载有依赖性。因此，相关资源有时不会在相应的指标触发时准时可用。

#### 例子 🌰

- 当 FCP 触发的时候，hero image 应该已经可以用于触发 LCP 了。
- 当 LCP 触发的时候，JS 应该已经被下载、解析和准备就绪（或者已经在执行）去不阻塞交互（FID）了。

### 网络/CPU 利用率

资源也没有适当的流水线去确保充分的利用 CPU 和网络。当进程被网络限制的时候，这会导致 CPU 出现“死区时间”，反之亦然。

一个很好的例子 🌰 就是可能被并行或者顺序下载的脚本。由于带宽在并发下载期间被划分，对于并行和顺序下载，整体的下载所有脚本的时间是一样的。如果并行下载脚本，CPU 在下载期间就未得到充分利用。然而，如果按顺序下载脚本，CPU 可以在下载第一个脚本后立即开始处理。这会达到更好的 CPU 和网络利用率。

### 第三方（3P）产品

常常需要第三方库来给网站增加通用的特性和功能。第三方库如广告、分析、社交部件、实时聊天和其他为网站提供支持的嵌入。一个第三方库会携带自己的 JS、图片和字体等等。

第三方产品通常没有动力去优化和支持消费方网站的加载性能。他们可能会有一个很沉重的 JS 执行花销，导致延迟交互性或者妨碍其他重要资源的下载。

开发人员包括第三方产品可能倾向于更多的关注他们在功能方面增加的价值，而不是性能影响。因此，第三方资源有时候会被随意的添加，而不会从如何加入到整体的加载顺序的角度来充分的考虑。这就会使得它们难以控制和安排。

### 平台怪癖（Platform Quirks）

> WIP

### HTTP2 优先（HTTP2 Prioritization）

> WIP

### 资源等里优化（Resource level optimization）

> WIP

## 更多资源信息 - 关系、约束和优先级（Relations, Constraints, and Priorities）

> WIP

### 关键 CSS（Critical CSS）

> WIP

### 字体

> WIP

### 首屏图像（Above the Fold (ATF) Images）

> WIP

### 不可视图像（Below the Fold (BTF) Images）

> WIP

### 1P JavaScript

> WIP

### 3P JavaScript

> WIP

## 什么是理性的加载顺序

> WIP

## 当前现状

> WIP

## 没有 3P 的建议顺序

> WIP

## 有 3P 的建议顺序

> WIP

## 结论

> WIP

## References

[1] hero image 通常指网页中用于吸引用户注意力和展示品牌形象的大型、突出的图片或图像。通常这些图片会放置在网页的顶部，通常是全屏或者横跨整个屏幕宽度。这些图片通常是高质量的，具有吸引人的外观和视觉效果，因此它们的加载速度和加载顺序对于提高用户体验和网站性能至关重要。
